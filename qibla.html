<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>‡¶ï‡¶ø‡¶¨‡¶≤‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶ï / Qibla Direction</title>
  <style>
    /* =========================
       Dark-green Islamic theme
       ========================= */
    :root{
      --bg:#0a1b14;
      --bg2:#0f251b;
      --card:#112a20;
      --accent:#00b3a4; /* teal for Qibla arrow */
      --accent2:#e3b04b; /* golden for dial rim */
      --text:#e7f3ed;
      --muted:#9fb7ad;
      --error:#ff6b6b;
      --ok:#59d390;
      --warn:#f7c948;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 50% -200px, #103224 0%, var(--bg) 60%, #08120e 100%);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
    }
    a,button{font-family:inherit}
    header{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 16px;border-bottom:1px solid #143528;background:var(--bg2);position:sticky;top:0;z-index:10;
    }
    header .title{
      font-weight:700;letter-spacing:0.2px;
    }
    header .title small{display:block;color:var(--muted);font-weight:500}
    .home-btn{
      background:#143528;color:var(--text);border:1px solid #1e4b39;border-radius:10px;padding:10px 14px;
      font-size:16px;display:flex;align-items:center;gap:8px;cursor:pointer
    }
    .home-btn:active{transform:scale(0.98)}
    main{
      display:flex;flex-direction:column;gap:12px;padding:12px;max-width:900px;margin:0 auto;
    }
    /* Panels */
    .panel{
      background:var(--card);border:1px solid #1a3e2f;border-radius:16px;padding:12px;
    }
    .panel h2{
      margin:0 0 8px 0;font-size:16px;color:var(--text);
    }
    .grid{
      display:grid;grid-template-columns:1fr;gap:12px;
    }
    @media (min-width:780px){
      .grid{grid-template-columns:1.2fr 1fr}
    }

    /* Compass card */
    .compass-wrap{
      display:flex;flex-direction:column;align-items:center;gap:10px;padding:8px;
    }
    .compass{
      position:relative;width:280px;height:280px;border-radius:50%;
      background: radial-gradient(120px 120px at 50% 50%, #0c1f17 30%, #0b1d15 70%);
      border:6px solid var(--accent2);
      box-shadow: 0 0 0 4px #102a21 inset, 0 10px 30px rgba(0,0,0,0.35);
      margin:6px auto;
    }
    .dial{
      position:absolute;inset:10px;border-radius:50%;border:1px dashed #1a4a39;
    }
    .tick{position:absolute;width:2px;height:10px;background:#1e5f4a;left:50%;transform-origin:0 130px;top:0}
    .tick.major{height:16px;background:#2b7a63}
    .cardinal{
      position:absolute;color:#d8e9e2;font-weight:700;font-size:14px;text-shadow:0 1px 1px #000;
    }
    .cardinal.n{top:6px;left:50%;transform:translateX(-50%)}
    .cardinal.s{bottom:6px;left:50%;transform:translateX(-50%)}
    .cardinal.e{top:50%;right:8px;transform:translateY(-50%)}
    .cardinal.w{top:50%;left:8px;transform:translateY(-50%)}
    /* Qibla arrow */
    .arrow{
      position:absolute;left:50%;top:50%;width:0;height:0;transform-origin:50% 100%;
      filter:drop-shadow(0 4px 6px rgba(0,0,0,0.35));
    }
    .arrow .shaft{
      position:absolute;left:-3px;top:-110px;width:6px;height:110px;background:linear-gradient(#007c74,#00b3a4);
      border-radius:3px 3px 0 0;
    }
    .arrow .head{
      position:absolute;left:-10px;top:-130px;width:20px;height:22px;background:var(--accent);
      clip-path:polygon(50% 0, 0 100%, 100% 100%);border-radius:2px;
    }
    .north-ref{
      position:absolute;left:50%;top:50%;width:0;height:0;transform-origin:50% 100%;
    }
    .north-ref .line{
      position:absolute;left:-2px;top:-120px;width:4px;height:120px;background:#b33;border-radius:2px;
    }
    .legend{font-size:13px;color:var(--muted);text-align:center}

    /* Readouts */
    .readouts{
      display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px;
    }
    .readout{
      background:#0d231a;border:1px solid #1a3e2f;border-radius:12px;padding:10px;
    }
    .readout b{color:var(--text)}
    .mono{font-feature-settings:"tnum" 1; font-variant-numeric: tabular-nums}
    .status{padding:8px;border-radius:10px;background:#0e231a;border:1px solid #1a3e2f;color:var(--muted)}
    .status.ok{color:var(--ok)}
    .status.error{color:var(--error)}
    .status.warn{color:var(--warn)}

    /* Controls */
    .controls{
      display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;
    }
    @media (max-width:420px){ .controls{grid-template-columns:1fr} }
    .btn{
      background:#143528;color:var(--text);border:1px solid #1e4b39;border-radius:12px;padding:12px;
      font-size:15px;display:flex;align-items:center;gap:8px;justify-content:center;cursor:pointer
    }
    .btn.secondary{
      background:#0d2219;border-color:#173729;color:#cfe6dc
    }
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    .toggle-row{
      display:flex;align-items:center;gap:10px;margin-top:8px
    }
    .switch{
      appearance:none;width:44px;height:24px;border-radius:999px;background:#173729;border:1px solid #265241;position:relative;cursor:pointer;
    }
    .switch:checked{background:#0e7a68;border-color:#0e7a68}
    .switch::after{
      content:"";position:absolute;width:18px;height:18px;border-radius:50%;background:#eaf6f2;top:2px;left:2px;transition:all .2s ease
    }
    .switch:checked::after{left:24px}

    /* Manual location */
    .manual{
      display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px
    }
    @media (max-width:520px){ .manual{grid-template-columns:1fr} }
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:13px;color:#cfe6dc}
    .field input, .field select{
      background:#0f241b;border:1px solid #1a3e2f;color:var(--text);border-radius:10px;padding:10px;font-size:15px
    }
    .field input.error{border-color:var(--error);background:#1a1616}
    .hint{font-size:12px;color:var(--muted)}
    .notice{font-size:12px;color:#c7dcd2;margin-top:6px}

    /* Map preview */
    .map{
      width:100%;height:160px;background:#0c1f17;border-radius:12px;border:1px solid #1a3e2f
    }

    footer{
      padding:12px;margin:10px auto;max-width:900px;color:#cfe6dc
    }
    .tips{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media (max-width:560px){ .tips{grid-template-columns:1fr} }
    .tip{background:#0d2219;border:1px solid #1a3e2f;border-radius:12px;padding:10px}
    .tip ul{margin:8px 0 0 18px}
    .tip li{margin:6px 0}
    /* Accessibility helpers */
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="title" aria-label="‡¶ï‡¶ø‡¶¨‡¶≤‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶ï / Qibla Direction">
      ‡¶ï‡¶ø‡¶¨‡¶≤‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶ï / Qibla Direction
      <small>‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ-‡¶™‡ßç‡¶∞‡¶•‡¶Æ UI with English fallback</small>
    </div>
    <button class="home-btn" id="homeBtn" aria-label="üè† ‡¶π‡ßã‡¶Æ‡ßá ‡¶´‡ßá‡¶∞‡¶§ / Back to Home">üè† ‡¶π‡ßã‡¶Æ‡ßá ‡¶´‡ßá‡¶∞‡¶§</button>
  </header>

  <!-- Main content -->
  <main>
    <div class="grid">
      <!-- Compass + map panel -->
      <section class="panel" aria-label="‡¶ï‡¶Æ‡ßç‡¶™‡¶æ‡¶∏ ‡¶ì ‡¶Æ‡¶æ‡¶®‡¶ö‡¶ø‡¶§‡ßç‡¶∞ / Compass and map">
        <h2>üß≠ ‡¶ï‡¶Æ‡ßç‡¶™‡¶æ‡¶∏ / Compass</h2>
        <div class="compass-wrap">
          <div class="compass" id="compass" aria-label="‡¶ï‡¶ø‡¶¨‡¶≤‡¶æ ‡¶ï‡¶Æ‡ßç‡¶™‡¶æ‡¶∏ / Qibla compass">
            <div class="dial" id="dial"></div>
            <!-- cardinal labels -->
            <div class="cardinal n">N</div>
            <div class="cardinal e">E</div>
            <div class="cardinal s">S</div>
            <div class="cardinal w">W</div>

            <!-- north reference (fixed to screen up) -->
            <div class="north-ref" id="northRef" style="transform: rotate(0deg);">
              <div class="line" title="True North"></div>
            </div>
            <!-- qibla arrow (rotates vs device heading) -->
            <div class="arrow" id="qiblaArrow" style="transform: rotate(0deg);" aria-label="‡¶ï‡¶ø‡¶¨‡¶≤‡¶æ ‡¶¶‡¶ø‡¶ï / Qibla arrow">
              <div class="shaft"></div>
              <div class="head"></div>
            </div>
          </div>

          <div class="legend">‡¶≤‡¶æ‡¶≤ ‡¶≤‡¶æ‡¶á‡¶®: ‡¶â‡¶§‡ßç‡¶§‡¶∞ (True North) ‚Ä¢ ‡¶ü‡¶ø‡¶≤ ‡¶∞‡¶ô‡ßá‡¶∞ ‡¶§‡ßÄ‡¶∞: ‡¶ï‡¶ø‡¶¨‡¶≤‡¶æ</div>

          <!-- Lightweight map preview (schematic) -->
          <canvas class="map" id="mapPreview" aria-label="‡¶∏‡¶ø‡¶Æ‡ßç‡¶™‡¶≤ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™ ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â / Simple map preview"></canvas>

          <!-- Readouts -->
          <div class="readouts">
            <div class="readout">
              <div><b>‡¶ï‡¶ø‡¶¨‡¶≤‡¶æ ‡¶ï‡ßã‡¶£:</b> <span id="bearingText" class="mono">‚Äî</span></div>
              <div><b>‡¶¶‡ßÇ‡¶∞‡¶§‡ßç‡¶¨ (‡¶ï‡¶æ‡¶¨‡¶æ):</b> <span id="distanceText" class="mono">‚Äî</span></div>
              <div><b>‡¶π‡ßá‡¶°‡¶ø‡¶Ç ‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø:</b> <span id="headingStability" class="mono">‚Äî</span></div>
            </div>
            <div class="readout">
              <div><b>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶®:</b> <span id="coordText" class="mono">‚Äî</span></div>
              <div><b>‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶Ø‡¶•‡¶æ‡¶∞‡ßç‡¶•‡¶§‡¶æ:</b> <span id="accuracyText" class="mono">‚Äî</span></div>
              <div><b>‡¶®‡¶∞‡ßç‡¶• ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏:</b> <span id="northMode" class="mono">True North</span></div>
            </div>
          </div>

          <div id="status" class="status">‡¶∏‡ßá‡¶®‡ßç‡¶∏‡¶∞ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡¶§‡ßá ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶¨‡ßã‡¶§‡¶æ‡¶Æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ If unavailable, use manual location.</div>

          <!-- Controls -->
          <div class="controls">
            <button class="btn" id="gpsBtn" aria-label="üìç ‡¶ú‡¶ø‡¶™‡¶ø‡¶è‡¶∏ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶® / Use GPS">üìç ‡¶ú‡¶ø‡¶™‡¶ø‡¶è‡¶∏ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button class="btn" id="compassBtn" aria-label="üß≠ ‡¶ï‡¶Æ‡ßç‡¶™‡¶æ‡¶∏ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶® / Enable Compass">üß≠ ‡¶ï‡¶Æ‡ßç‡¶™‡¶æ‡¶∏ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button class="btn secondary" id="manualBtn" aria-label="‚úè ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® / Manual Location">‚úè ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶®</button>
            <div class="toggle-row">
              <label for="northSwitch">True/Magnetic North</label>
              <input type="checkbox" id="northSwitch" class="switch" aria-label="True/Magnetic North toggle" />
            </div>
          </div>

          <!-- Manual location section -->
          <div id="manualSection" class="panel" style="margin-top:10px; display:none" aria-label="‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶á‡¶®‡¶™‡ßÅ‡¶ü / Manual location inputs">
            <h2>üìç ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤‡¶ø ‡¶¶‡¶ø‡¶® / Manual Location</h2>
            <div class="manual">
              <div class="field">
                <label for="latInput">‡¶Ö‡¶ï‡ßç‡¶∑‡¶æ‡¶Ç‡¶∂ (Latitude)</label>
                <input type="text" id="latInput" inputmode="decimal" placeholder="‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£: 24.85" />
                <small class="hint">-90 ‡¶•‡ßá‡¶ï‡ßá 90 ‡¶è‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá</small>
              </div>
              <div class="field">
                <label for="lonInput">‡¶¶‡ßç‡¶∞‡¶æ‡¶ò‡¶ø‡¶Æ‡¶æ‡¶Ç‡¶∂ (Longitude)</label>
                <input type="text" id="lonInput" inputmode="decimal" placeholder="‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£: 89.37" />
                <small class="hint">-180 ‡¶•‡ßá‡¶ï‡ßá 180 ‡¶è‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá</small>
              </div>
              <div class="field">
                <label for="citySelect">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶∂‡¶π‡¶∞‡¶∏‡¶Æ‡ßÇ‡¶π / BD Presets</label>
                <select id="citySelect">
                  <option value="">‡¶∂‡¶π‡¶∞ ‡¶¨‡¶æ‡¶õ‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶® / Select a city</option>
                  <option value="23.8103,90.4125">‡¶¢‡¶æ‡¶ï‡¶æ (Dhaka)</option>
                  <option value="24.8464,89.3776">‡¶¨‡¶ó‡ßÅ‡¶°‡¶º‡¶æ (Bogra)</option>
                  <option value="24.3636,88.6241">‡¶∞‡¶æ‡¶ú‡¶∂‡¶æ‡¶π‡ßÄ (Rajshahi)</option>
                  <option value="22.3569,91.7832">‡¶ö‡¶ü‡ßç‡¶ü‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ (Chittagong)</option>
                  <option value="24.8949,91.8687">‡¶∏‡¶ø‡¶≤‡ßá‡¶ü (Sylhet)</option>
                  <option value="22.8456,89.5403">‡¶ñ‡ßÅ‡¶≤‡¶®‡¶æ (Khulna)</option>
                  <option value="22.7010,90.3535">‡¶¨‡¶∞‡¶ø‡¶∂‡¶æ‡¶≤ (Barishal)</option>
                  <option value="25.7439,89.2752">‡¶∞‡¶Ç‡¶™‡ßÅ‡¶∞ (Rangpur)</option>
                </select>
              </div>
              <div class="field">
                <button class="btn" id="applyManual" aria-label="‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® / Apply location">‚úî ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® / Apply</button>
                <small class="notice">Sensors unavailable? Manual works fully offline.</small>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Info + help panel -->
      <section class="panel" aria-label="‡¶§‡¶•‡ßç‡¶Ø ‡¶ì ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ / Info and help">
        <h2>‚Ñπ ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶®‡¶æ / Instructions</h2>
        <div class="status warn" id="info">
          Android WebView orientation may need HTTPS and a user gesture. Tap ‚Äúüß≠ ‡¶ï‡¶Æ‡ßç‡¶™‡¶æ‡¶∏ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®‚Äù and move the phone slowly.
          On iOS, you may be asked to grant motion/gyroscope permission after tapping the compass button.
        </div>
        <div class="status" style="margin-top:8px">
          ‡¶Ø‡¶¶‡¶ø ‡¶ï‡¶Æ‡ßç‡¶™‡¶æ‡¶∏ ‡¶ï‡¶æ‡¶ú ‡¶®‡¶æ ‡¶ï‡¶∞‡ßá, ‡¶Ü‡¶™‡¶®‡¶ø ‡¶∏‡ßç‡¶•‡¶ø‡¶∞ ‡¶ï‡¶ø‡¶¨‡¶≤‡¶æ ‡¶ï‡ßã‡¶£ ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶¨‡ßá‡¶® ‡¶è‡¶¨‡¶Ç ‚ÄúRotate phone ‚Ä¶¬∞‚Äù ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶®‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶∞‡¶£ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§
        </div>
      </section>
    </div>
  </main>

  <!-- Footer tips -->
  <footer>
    <div class="tips">
      <div class="tip">
        <b>‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶¨‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶ü‡¶ø‡¶™‡¶∏ / Calibration Tips</b>
        <ul>
          <li>‡¶´‡ßã‡¶®‡¶ï‡ßá ‡¶´‡¶ø‡¶ó‡¶æ‡¶∞-‡¶è‡¶á‡¶ü ‡¶Ü‡¶ï‡¶æ‡¶∞‡ßá ‡¶®‡¶æ‡¶°‡¶º‡¶æ‡¶®</li>
          <li>‡¶ß‡¶æ‡¶§‡¶¨ ‡¶¨‡¶∏‡ßç‡¶§‡ßÅ ‡¶•‡ßá‡¶ï‡ßá ‡¶¶‡ßÇ‡¶∞‡ßá ‡¶•‡¶æ‡¶ï‡ßÅ‡¶®</li>
          <li>‡¶ï‡¶≠‡¶æ‡¶∞ ‡¶ñ‡ßÅ‡¶≤‡ßá ‡¶®‡¶ø‡¶®</li>
          <li>‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶®‡¶ø‡¶ï‡ßç‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶¶‡ßÇ‡¶∞‡ßá ‡¶•‡¶æ‡¶ï‡ßÅ‡¶®</li>
        </ul>
      </div>
      <div class="tip">
        <b>True vs Magnetic North</b>
        <p style="margin-top:6px">
          Magnetic declination varies by location and time. If declination is not exposed by your device, we use True North.
          The toggle is informational on most devices.
        </p>
      </div>
    </div>
    <div class="sr-only" aria-hidden="true">Standalone web app. No external libraries.</div>
  </footer>

  <script>
    /* ============================================================
       Qibla Direction Web App - HTML/CSS/Vanilla JS (Mobile-first)
       Embedded-friendly for Android WebView, Bengali-first UI
       ============================================================ */

    // -----------------------------
    // Constants & State
    // -----------------------------
    const KAABA = { lat: 21.4225, lon: 39.8262 };
    const R_EARTH_KM = 6371;
    const DEFAULT_LOCATION = { lat: 24.8464, lon: 89.3776 }; // Bogra, Rajshahi, Bangladesh

    let userLat = null, userLon = null;
    let gpsAccuracyM = null;
    let lastBearingToKaaba = null; // absolute bearing vs true north
    let haveHeading = false;
    let useMagneticNorth = false; // informational unless device provides declination
    let headingDeg = 0; // device heading vs true north
    let headingFiltered = null;
    let headingSamples = [];
    let animationRequested = false;

    // UI refs
    const statusEl = document.getElementById('status');
    const bearingTextEl = document.getElementById('bearingText');
    const distanceTextEl = document.getElementById('distanceText');
    const coordTextEl = document.getElementById('coordText');
    const accuracyTextEl = document.getElementById('accuracyText');
    const northModeEl = document.getElementById('northMode');
    const headingStabilityEl = document.getElementById('headingStability');
    const qiblaArrowEl = document.getElementById('qiblaArrow');
    const northRefEl = document.getElementById('northRef');
    const dialEl = document.getElementById('dial');
    const mapCanvas = document.getElementById('mapPreview');

    const gpsBtn = document.getElementById('gpsBtn');
    const compassBtn = document.getElementById('compassBtn');
    const manualBtn = document.getElementById('manualBtn');
    const manualSection = document.getElementById('manualSection');
    const applyManualBtn = document.getElementById('applyManual');
    const latInput = document.getElementById('latInput');
    const lonInput = document.getElementById('lonInput');
    const citySelect = document.getElementById('citySelect');
    const northSwitch = document.getElementById('northSwitch');
    const homeBtn = document.getElementById('homeBtn');

    // -----------------------------
    // Storage helpers
    // -----------------------------
    function saveLocation(lat, lon){
      try{
        localStorage.setItem('qibla_lat', String(lat));
        localStorage.setItem('qibla_lon', String(lon));
      }catch(e){}
    }
    function loadLocation(){
      try{
        const lat = parseFloat(localStorage.getItem('qibla_lat'));
        const lon = parseFloat(localStorage.getItem('qibla_lon'));
        if(isFinite(lat) && isFinite(lon)) return { lat, lon };
      }catch(e){}
      return null;
    }

    // -----------------------------
    // Math helpers
    // -----------------------------
    function deg2rad(d){ return d * Math.PI / 180; }
    function rad2deg(r){ return r * 180 / Math.PI; }
    function normalizeDeg(d){
      let x = d % 360;
      if(x < 0) x += 360;
      return x;
    }

    // Initial bearing (forward azimuth) from (lat1, lon1) to KAABA
    function initialBearingToKaaba(lat1, lon1){
      const lat1r = deg2rad(lat1), lon1r = deg2rad(lon1);
      const lat2r = deg2rad(KAABA.lat), lon2r = deg2rad(KAABA.lon);
      const dLon = lon2r - lon1r;
      const y = Math.sin(dLon) * Math.cos(lat2r);
      const x = Math.cos(lat1r)*Math.sin(lat2r) - Math.sin(lat1r)*Math.cos(lat2r)*Math.cos(dLon);
      const theta = Math.atan2(y, x);
      return normalizeDeg(rad2deg(theta)); // 0..360 vs True North
    }

    // Distance to Kaaba using haversine (km)
    function distanceToKaaba(lat1, lon1){
      const lat1r = deg2rad(lat1), lon1r = deg2rad(lon1);
      const lat2r = deg2rad(KAABA.lat), lon2r = deg2rad(KAABA.lon);
      const dLat = lat2r - lat1r;
      const dLon = lon2r - lon1r;
      const a = Math.sin(dLat/2)*2 + Math.cos(lat1r)*Math.cos(lat2r)*Math.sin(dLon/2)*2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R_EARTH_KM * c;
    }

    // Direction label from bearing
    function getDirectionLabel(b){
      const labels = [
        {name:'N',deg:0},
        {name:'NNE',deg:22.5},
        {name:'NE',deg:45},
        {name:'ENE',deg:67.5},
        {name:'E',deg:90},
        {name:'ESE',deg:112.5},
        {name:'SE',deg:135},
        {name:'SSE',deg:157.5},
        {name:'S',deg:180},
        {name:'SSW',deg:202.5},
        {name:'SW',deg:225},
        {name:'WSW',deg:247.5},
        {name:'W',deg:270},
        {name:'WNW',deg:292.5},
        {name:'NW',deg:315},
        {name:'NNW',deg:337.5}
      ];
      let nearest = labels[0], minDiff = 360;
      for(const l of labels){
        const diff = Math.abs(normalizeDeg(b - l.deg));
        if(diff < minDiff){ minDiff = diff; nearest = l; }
      }
      return nearest.name;
    }

    // -----------------------------
    // UI helpers
    // -----------------------------
    function setStatus(message, cls=''){
      statusEl.textContent = message;
      statusEl.className = 'status' + (cls ? ' ' + cls : '');
    }
    function setError(message){
      statusEl.textContent = message;
      statusEl.className = 'status error';
    }

    // Update compass UI
    // bearingToNorthDeg: device heading vs True North (0..360). If null => no heading.
    // qiblaBearingDeg: absolute bearing vs True North
    function updateCompassUI(bearingToNorthDeg, qiblaBearingDeg){
      try{
        // Arrow rotation: relative to device heading
        let rel = qiblaBearingDeg;
        if(bearingToNorthDeg != null){
          rel = normalizeDeg(qiblaBearingDeg - bearingToNorthDeg);
        }
        qiblaArrowEl.style.transform = `rotate(${rel}deg)`;

        // Dial ticks and map preview refresh
        drawDialTicks();
        drawMapPreview(qiblaBearingDeg);

        // Readouts
        const dirLabel = getDirectionLabel(qiblaBearingDeg);
        const distKm = distanceToKaaba(userLat, userLon);
        bearingTextEl.textContent = `${Math.round(qiblaBearingDeg)}¬∞ (${dirLabel})`;
        distanceTextEl.textContent = `${Math.round(distKm)} ‡¶ï‡¶ø‡¶Æ‡¶ø`;

        const coordStr = (userLat!=null && userLon!=null) ? `${userLat.toFixed(5)}, ${userLon.toFixed(5)}` : '‚Äî';
        coordTextEl.textContent = coordStr;
        accuracyTextEl.textContent = (gpsAccuracyM!=null) ? `${Math.round(gpsAccuracyM)} ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞` : '‚Äî';

        // Heading stability badge (variance of last samples)
        const stability = computeHeadingStability();
        headingStabilityEl.textContent = stability ? '‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø‡¶∂‡ßÄ‡¶≤' : '‡¶Ö‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø‡¶∂‡ßÄ‡¶≤';
      }catch(e){
        setError('UI ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
        console.error(e);
      }
    }

    // Draw degree ticks and cardinal ring once per frame
    function drawDialTicks(){
      if(dialEl.dataset.built === '1') return;
      const center = {x:140,y:140};
      // Create ticks each 10¬∞, major every 30¬∞
      for(let d=0; d<360; d+=10){
        const tick = document.createElement('div');
        tick.className = 'tick' + (d%30===0 ? ' major' : '');
        tick.style.transform = `rotate(${d}deg) translateX(${center.x-10}px)`;
        dialEl.appendChild(tick);
      }
      dialEl.dataset.built = '1';
    }

    // Minimal schematic map: draw north line and qibla line from center
    function drawMapPreview(qiblaBearingDeg){
      const ctx = mapCanvas.getContext('2d');
      const w = mapCanvas.width = mapCanvas.clientWidth;
      const h = mapCanvas.height = mapCanvas.clientHeight;
      const cx = w/2, cy = h/2;
      ctx.clearRect(0,0,w,h);

      // Background grid
      ctx.strokeStyle = '#164536';
      ctx.lineWidth = 1;
      for(let x=0;x<w;x+=20){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
      for(let y=0;y<h;y+=20){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }

      // Center point
      ctx.fillStyle = '#cfe6dc';
      ctx.beginPath(); ctx.arc(cx,cy,3,0,Math.PI*2); ctx.fill();

      // North reference (up)
      ctx.strokeStyle = '#b33';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.lineTo(cx, 20);
      ctx.stroke();
      ctx.fillStyle = '#b33';
      ctx.fillText('N', cx+6, 28);

      // Qibla line
      const len = Math.min(w,h)/2 - 20;
      const theta = deg2rad(-qiblaBearingDeg + 90); // canvas y-down correction
      const qx = cx + len * Math.cos(theta);
      const qy = cy + len * Math.sin(theta);
      ctx.strokeStyle = '#00b3a4';
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.lineTo(qx, qy);
      ctx.stroke();
      ctx.fillStyle = '#00b3a4';
      ctx.fillText('Qibla', qx+6, qy+6);
    }

    // Heading stability: compute standard deviation of last N samples
    function computeHeadingStability(){
      if(headingSamples.length < 10) return false;
      const mean = headingSamples.reduce((a,b)=>a+b,0) / headingSamples.length;
      const variance = headingSamples.reduce((a,b)=>a + (b-mean)*(b-mean),0) / headingSamples.length;
      return variance < 25; // heuristic threshold
    }

    // -----------------------------
    // Sensors: Geolocation & Orientation
    // -----------------------------
    async function startSensors(){
      // Geolocation
      try{
        setStatus('‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶®‡¶ø‡¶ö‡ßç‡¶õ‡¶ø‚Ä¶ Please allow GPS.', 'warn');
        navigator.geolocation.getCurrentPosition(pos=>{
          const { latitude, longitude, accuracy } = pos.coords;
          userLat = latitude; userLon = longitude; gpsAccuracyM = accuracy;
          saveLocation(userLat, userLon);
          lastBearingToKaaba = initialBearingToKaaba(userLat, userLon);
          updateCompassUI(haveHeading ? headingFiltered ?? headingDeg : null, lastBearingToKaaba);
          setStatus('‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§‡•§ ‡¶ï‡¶ø‡¶¨‡¶≤‡¶æ ‡¶ï‡ßã‡¶£ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', 'ok');
          // Watch position for improved accuracy
          navigator.geolocation.watchPosition(p=>{
            const { latitude, longitude, accuracy } = p.coords;
            userLat = latitude; userLon = longitude; gpsAccuracyM = accuracy;
            saveLocation(userLat, userLon);
            lastBearingToKaaba = initialBearingToKaaba(userLat, userLon);
            scheduleAnimation();
          }, err=>{
            console.warn('watchPosition error', err);
          }, { enableHighAccuracy:true, maximumAge:5000, timeout:10000 });
        }, err=>{
          console.warn('getCurrentPosition error', err);
          setStatus('‡¶ú‡¶ø‡¶™‡¶ø‡¶è‡¶∏ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶¶‡ßá‡¶Ø‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø ‡¶¨‡¶æ ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§ Manual location ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'error');
          showManual();
          // Fallback to last saved or default
          const saved = loadLocation() || DEFAULT_LOCATION;
          userLat = saved.lat; userLon = saved.lon; gpsAccuracyM = null;
          lastBearingToKaaba = initialBearingToKaaba(userLat, userLon);
          scheduleAnimation();
        }, { enableHighAccuracy:true, maximumAge:3000, timeout:10000 });
      }catch(e){
        setError('‡¶ú‡¶ø‡¶™‡¶ø‡¶è‡¶∏ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ Manual location ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
        showManual();
      }

      // Device orientation
      try{
        // iOS needs explicit permission via user gesture
        if(typeof DeviceOrientationEvent !== 'undefined' &&
           typeof DeviceOrientationEvent.requestPermission === 'function'){
          // wait for button gesture (handled in compassBtn click)
        }else{
          // Android & others: add listeners directly
          window.addEventListener('deviceorientation', onDeviceOrientation, { passive:true });
          window.addEventListener('devicemotion', onDeviceMotion, { passive:true });
        }
      }catch(e){
        console.warn('Orientation setup error', e);
        setStatus('‡¶ï‡¶Æ‡ßç‡¶™‡¶æ‡¶∏ ‡¶∏‡ßá‡¶®‡ßç‡¶∏‡¶∞ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶∏‡ßç‡¶•‡¶ø‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶®‡¶æ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§', 'warn');
      }
    }

    function stopSensors(){
      try{
        window.removeEventListener('deviceorientation', onDeviceOrientation);
        window.removeEventListener('devicemotion', onDeviceMotion);
        haveHeading = false;
        headingSamples = [];
        setStatus('‡¶∏‡ßá‡¶®‡ßç‡¶∏‡¶∞ ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', 'warn');
      }catch(e){
        console.warn(e);
      }
    }

    // Orientation handler with low-pass filter & platform quirks
    function onDeviceOrientation(ev){
      let alpha = ev.alpha; // 0..360, degrees
      let absolute = ev.absolute || false;
      let webkitHeading = ev.webkitCompassHeading; // iOS Safari/WebKit
      // Prefer absolute heading if available
      let h;
      if(typeof webkitHeading === 'number' && isFinite(webkitHeading)){
        h = webkitHeading; // iOS gives heading vs magnetic north typically
      }else if(typeof alpha === 'number'){
        h = normalizeDeg(alpha);
      }else{
        return;
      }
      // Simple low-pass filter to reduce jitter
      if(headingFiltered == null) headingFiltered = h;
      const alphaLP = 0.15; // smoothing factor
      headingFiltered = headingFiltered + alphaLP * (h - headingFiltered);
      headingDeg = normalizeDeg(headingFiltered);
      haveHeading = true;
      // track for stability
      headingSamples.push(headingDeg);
      if(headingSamples.length > 40) headingSamples.shift();

      scheduleAnimation();
    }

    function onDeviceMotion(ev){
      // Could use rotationRate to detect instability, here we rely on variance.
      // Left intentionally light to keep performance.
    }

    function scheduleAnimation(){
      if(animationRequested) return;
      animationRequested = true;
      requestAnimationFrame(()=>{
        animationRequested = false;
        updateCompassUI(haveHeading ? headingDeg : null, lastBearingToKaaba);
        // Provide rotate instruction if no heading
        if(!haveHeading){
          const rel = normalizeDeg(lastBearingToKaaba);
          const instructionDegLeft = Math.round((360 - rel) % 360);
          setStatus(`‡¶ï‡¶Æ‡ßç‡¶™‡¶æ‡¶∏ ‡¶∏‡ßá‡¶®‡ßç‡¶∏‡¶∞ ‡¶¨‡¶®‡ßç‡¶ß‡•§ ‡¶´‡ßã‡¶®‡¶ü‡¶ø ‡¶¨‡¶æ‡¶Æ‡ßá ${instructionDegLeft}¬∞ ‡¶ò‡ßã‡¶∞‡¶æ‡¶® ‡¶Ø‡¶æ‡¶§‡ßá ‡¶§‡ßÄ‡¶∞ ‡¶â‡¶™‡¶∞‡ßá‡¶∞ ‡¶¶‡¶ø‡¶ï‡ßá ‡¶•‡¶æ‡¶ï‡ßá‡•§`, 'warn');
        }else{
          setStatus('‡¶ï‡¶Æ‡ßç‡¶™‡¶æ‡¶∏ ‡¶ö‡¶æ‡¶≤‡ßÅ‡•§ ‡¶≤‡¶æ‡¶á‡¶≠ ‡¶ï‡¶ø‡¶¨‡¶≤‡¶æ ‡¶§‡ßÄ‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§', 'ok');
        }
        postToParent();
      });
    }

    // -----------------------------
    // Events & permissions
    // -----------------------------
    gpsBtn.addEventListener('click', ()=>{
      startSensors();
    });

    compassBtn.addEventListener('click', async ()=>{
      try{
        // iOS permission request (requires user gesture)
        if(typeof DeviceOrientationEvent !== 'undefined' &&
           typeof DeviceOrientationEvent.requestPermission === 'function'){
          const resp = await DeviceOrientationEvent.requestPermission();
          if(resp === 'granted'){
            window.addEventListener('deviceorientation', onDeviceOrientation, { passive:true });
            window.addEventListener('devicemotion', onDeviceMotion, { passive:true });
            setStatus('‡¶ï‡¶Æ‡ßç‡¶™‡¶æ‡¶∏ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', 'ok');
          }else{
            setStatus('‡¶ï‡¶Æ‡ßç‡¶™‡¶æ‡¶∏ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶®‡•§ ‡¶∏‡ßç‡¶•‡¶ø‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶®‡¶æ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá‡•§', 'error');
          }
        }else{
          // Non-iOS: already listening or will start
          window.addEventListener('deviceorientation', onDeviceOrientation, { passive:true });
          window.addEventListener('devicemotion', onDeviceMotion, { passive:true });
          setStatus('‡¶ï‡¶Æ‡ßç‡¶™‡¶æ‡¶∏ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', 'ok');
        }
      }catch(e){
        setError('‡¶ï‡¶Æ‡ßç‡¶™‡¶æ‡¶∏ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡¶ø‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§');
      }
    });

    manualBtn.addEventListener('click', showManual);
    function showManual(){
      manualSection.style.display = 'block';
    }

    applyManualBtn.addEventListener('click', ()=>{
      const latStr = latInput.value.trim();
      const lonStr = lonInput.value.trim();
      const lat = parseFloat(latStr);
      const lon = parseFloat(lonStr);
      let valid = true;
      if(!isFinite(lat) || lat < -90 || lat > 90){ latInput.classList.add('error'); valid=false; } else { latInput.classList.remove('error'); }
      if(!isFinite(lon) || lon < -180 || lon > 180){ lonInput.classList.add('error'); valid=false; } else { lonInput.classList.remove('error'); }
      if(!valid){
        setError('‡¶Ö‡¶¨‡ßà‡¶ß ‡¶Ö‡¶ï‡ßç‡¶∑‡¶æ‡¶Ç‡¶∂/‡¶¶‡ßç‡¶∞‡¶æ‡¶ò‡¶ø‡¶Æ‡¶æ‡¶Ç‡¶∂‡•§ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶Æ‡¶æ‡¶® ‡¶¶‡¶ø‡¶®‡•§');
        return;
      }
      userLat = lat; userLon = lon; gpsAccuracyM = null;
      saveLocation(userLat, userLon);
      lastBearingToKaaba = initialBearingToKaaba(userLat, userLon);
      scheduleAnimation();
      setStatus('‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', 'ok');
    });

    citySelect.addEventListener('change', ()=>{
      const val = citySelect.value;
      if(!val) return;
      const [latStr, lonStr] = val.split(',');
      latInput.value = latStr;
      lonInput.value = lonStr;
      applyManualBtn.click();
    });

    northSwitch.addEventListener('change', ()=>{
      useMagneticNorth = northSwitch.checked;
      // We keep it informational in absence of declination API.
      northModeEl.textContent = useMagneticNorth ? 'Magnetic North (Approx.)' : 'True North';
      setStatus(useMagneticNorth
        ? 'Magnetic North ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ (‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶æ‡¶®)‡•§ ‡¶¨‡ßá‡¶∂‡¶ø‡¶∞‡¶≠‡¶æ‡¶ó ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏‡ßá True North ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡ßÉ‡¶§ ‡¶π‡¶Ø‡¶º‡•§'
        : 'True North ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§‡•§', 'warn');
      scheduleAnimation();
    });

    homeBtn.addEventListener('click', ()=>{
      // Replace route here if needed by host app
      window.location.href = 'index.html';
    });

    // -----------------------------
    // Initialization
    // -----------------------------
    (function init(){
      // Restore location or default
      const saved = loadLocation();
      const loc = saved || DEFAULT_LOCATION;
      userLat = loc.lat; userLon = loc.lon;
      lastBearingToKaaba = initialBearingToKaaba(userLat, userLon);
      scheduleAnimation();
    })();

    // -----------------------------
    // Host app integration (postMessage)
    // -----------------------------
    function postToParent(){
      try{
        const payload = {
          type: 'qibla_update',
          lat: userLat, lon: userLon,
          bearingDeg: lastBearingToKaaba,
          distanceKm: userLat!=null && userLon!=null ? distanceToKaaba(userLat, userLon) : null,
          headingDeg: haveHeading ? headingDeg : null,
          gpsAccuracyM
        };
        // Parent WebView can listen to this
        window.postMessage(payload, '*');
      }catch(e){
        // Ignore
      }
    }
  </script>
</body>
</html>